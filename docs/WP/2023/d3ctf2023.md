å„ä½âœŒçš„writeupï¼š

ğŸ‘‰[2023 AntCTF x D^3CTF äºšå†› Writeup By S1uM4in)](https://fq6p9pyo5tt.feishu.cn/docx/InUFdQUKdozf8yx5IhGcf5zInSe)

ğŸ‘‰[2023 D^3CTF writeup by ä¸‡å¹´ä¸‰ç­‰å¥–](https://mp.weixin.qq.com/s?__biz=Mzg4MjcxMTAwMQ==&mid=2247486967&idx=1&sn=ad55ddd11c6bfa17843270625f5f92fc&chksm=cf53cd41f8244457c2db68626c91f2e4564d756b903222f3a913e89f211d475418864c5041bc&mpshare=1&scene=23&srcid=0501bEUrW8ydbpm175TL5FFn&sharer_sharetime=1682949687637&sharer_shareid=6eea79ff6da57fc6752ab0bc570bf392#rd)

ğŸ‘‰è¿˜æœ‰ä¸ªå®˜æ–¹çš„wpï¼Œå°±ä¸æ”¾äº†

# d3syscall

é¦–å…ˆçœ‹mainï¼Œå¤§æ¦‚é€»è¾‘å°±æ˜¯è¾“å…¥flagï¼Œæ£€æµ‹ã€‚

![mainå‡½æ•°](d3ctf2023/image-20230507181209469.png)

sub_D3F5å°±æ˜¯æ£€æµ‹å‡½æ•°ã€‚

![æ£€æµ‹å‡½æ•°sub_D3F5](d3ctf2023/image-20230507181232317.png)

æ˜¯syscallè¿›è¡Œçš„ç³»ç»Ÿè°ƒç”¨ï¼Œè°ƒç”¨çš„æ“ä½œç”±eaxçš„å€¼å†³å®šã€‚

å› æ­¤éœ€è¦çœ‹syscallçš„è°ƒç”¨æœ‰ä»€ä¹ˆã€‚

æ¥åˆ°sub_1830ï¼Œè¿™é‡Œæœ‰å¯¹æ•°æ®æ®µå–éï¼Œå¹¶å†™æ–‡ä»¶çš„æ“ä½œï¼Œè¿˜æœ‰å¯¹å­—ç¬¦ä¸²å¼‚æˆ–çš„æ“ä½œã€‚

ä½†å…¶å®æˆ‘å¹¶ä¸çŸ¥é“ä¸ºä»€ä¹ˆç¨‹åºä¼šæ¥åˆ°è¿™é‡Œï¼Œè¿˜æ˜¯éœ€è¦ç³»ç»Ÿåœ°å­¦ä¹ ä¸€ä¸‹ç¨‹åºæ‰§è¡Œçš„æµç¨‹ç­‰çŸ¥è¯†å•Šã€‚

![sub_1830](d3ctf2023/image-20230507202136815.png)

å¯¹unk_4020æ•°æ®æ®µçš„å–éæ“ä½œï¼Œå¯ä»¥åœ¨åŠ¨æ€è°ƒè¯•ä¸‹ç›´æ¥æŠŠç»“æœdumpå‡ºæ¥ï¼Œçœ‹æ–‡ä»¶å¤´å¯ä»¥çŸ¥é“æ˜¯ä¸€ä¸ªæ–°çš„ELFæ–‡ä»¶ã€‚

![å–éç»“æœ](d3ctf2023/image-20230507181121914.png)

ä¹Ÿå¯ä»¥ä½¿ç”¨ç”Ÿæˆçš„æ–‡ä»¶ï¼Œè·¯å¾„ä¸º`/tmp/my_module`ã€‚

![æ–‡ä»¶è·¯å¾„](d3ctf2023/image-20230507181136870.png)

åœ¨dumpæ–‡ä»¶çš„init_moduleå‡½æ•°ä¸­ï¼ŒçŒœæµ‹å°±æ˜¯æ›´æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨çš„è¿‡ç¨‹ã€‚

v4çš„ä¸‹è¡¨å¯¹åº”æ£€æµ‹å‡½æ•°æ¯ä¸€ä¸ªsyscallçš„eaxå–å€¼ã€‚

> ç¨‹åºé¦–å…ˆä»`/proc/kallsyms`ä¸­è·å–äº†ç³»ç»Ÿè°ƒç”¨è¡¨çš„åœ°å€ï¼Œé€šè¿‡å‚æ•°ä¼ é€’åˆ°å†…æ ¸æ¨¡å—ä¸­ï¼Œå†…æ ¸æ¨¡å—é‡Œæ³¨å†Œäº†`Linux`ä¿ç•™çš„ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ†åˆ«ä¸ºï¼š335ï¼šMOVï¼Œ336ï¼šALUï¼Œ337ï¼šPUSHï¼Œ338ï¼šPOPï¼Œ339ï¼šresetregï¼Œ340ï¼šcheckflagã€‚

![init_module](d3ctf2023/image-20230507204944395.png)

ä¸€å…±æ›´æ”¹äº†äº”ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚

MOVè°ƒç”¨ï¼š

![MOV](d3ctf2023/image-20230507205002664.png)

PUSHè°ƒç”¨ï¼š

![PUSH](d3ctf2023/image-20230507205018345.png)

POPè°ƒç”¨ï¼š

![POP](d3ctf2023/image-20230507205034902.png)

resetregè°ƒç”¨ï¼š

![resetreg](d3ctf2023/image-20230507181619340.png)

checkflagè°ƒç”¨ï¼š

å°†v4ä¸å¤„ç†è¿‡åçš„è¾“å…¥ä½œæ¯”è¾ƒï¼Œè¿›è¡Œæ£€æµ‹ã€‚

![checkflag](d3ctf2023/image-20230507204810730.png)

è¿ç®—æ“ä½œï¼š

![AUL_1](d3ctf2023/image-20230507205445965.png)

![AUL_2](d3ctf2023/image-20230507205505877.png)

çŸ¥é“äº†è°ƒç”¨ï¼Œç°åœ¨åªéœ€è¦çŸ¥é“è°ƒç”¨çš„æµç¨‹å°±å¯ä»¥äº†ã€‚

wpé‡Œç»™å‡ºäº†ä¸€ä¸ªååˆ†æ–¹ä¾¿çš„æ–¹æ³•ï¼šä½¿ç”¨straceã€‚(ä½†å…¶å®æ ¹æ®æ±‡ç¼–æ¥çœ‹ä¹Ÿè¡Œï¼Œä½†å¾ˆéº»çƒ¦)

![starce](d3ctf2023/image-20230507181341809.png)

![æµç¨‹ï¼ˆæœªå®Œï¼‰](d3ctf2023/image-20230507181409731.png)

å°†ç»“æœéƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼Œå†ä»£å…¥wpä¸­çš„è„šæœ¬ä¸­å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ£€æµ‹çš„é€»è¾‘ï¼š

```Python
bytecode = [
    [0x14f, 0x1, 0, 0x3837363534333231, 0, 0x5564c32f4027, 0x7fd40816fa80],
    [0x14f, 0x1, 0x1, 0x6665646362613039, 0, 0x5564c32f4027, 0x7fd40816fa80],
    [0x151, 0, 0x1, 0x6665646362613039, 0, 0x5564c32f4027, 0x7fd40816fa80],
    ...
]


def mov(code):
    match code[1]:
        case 0:
            print(f"mov reg[{code[2]}],reg[{code[3]}]")
        case 1:
            print(f"mov reg[{code[2]}],{hex(code[3])}")


def alu(code):
    match code[1]:
        case 0:
            print(f"add reg[{code[2]}],reg[{code[3]}]")
        case 1:
            print(f"sub reg[{code[2]}],reg[{code[3]}]")
        case 2:
            print(f"mul reg[{code[2]}],reg[{code[3]}]")
        case 3:
            print(f"xor reg[{code[2]}],reg[{code[3]}]")
        case 4:
            print(f"shl reg[{code[2]}],reg[{code[3]}]")
        case 5:
            print(f"shr reg[{code[2]}],reg[{code[3]}]")


def push(code):
    match code[1]:
        case 0:
            print(f"push reg[{code[2]}]")
        case 1:
            print(f"push {hex(code[2])}")


def pop(code):
    print(f"pop reg[{code[1]}]")


for i in bytecode:
    match i[0]:
        case 335:
            mov(i)
        case 336:
            alu(i)
        case 337:
            push(i)
        case 338:
            pop(i)
        case 339:
            print("resetreg")
        case 340:
            print("checkflag")
```

åœ¨å¯¹é€»è¾‘çš„ä»£ç é‡æ–°æ•´ç†å¾—åˆ°ï¼š

```
input = [32bit] * 6
stack = []
r0 = input[0]
r1 = input[1]
stack.append(r1)
r2 = r0 << 3 + 0x51e7647e
r3 = r0 * 3 + 0xe0b4140a
r2 = r2 ^ r3
r2 ^= (r0 + 0xe6978f27)
stack.pop()
r1 = r1 + r2
stack.append(r1)
stack.append(r0)
r2 = r1 << 6 + 0x53a35337
r3 = r1 * 5 + 0x9840294d
r2 = r2 ^ r3
r3 = r1 - 0x5eae4751
r2 = r2 ^ r3
stack.pop(r0)
stack.append(r0 + r2)

r0 = input[2]
r1 = input[3]
stack.append(0)
r2 = r0 << 3 + 0x51e7647e
r3 = r0 * 3 + 0xe0b4140a
r2 = r2 ^ r3
r2 ^= (r0 + 0xe6978f27)
stack.pop(r1)
r1 += r2
stack.append(r1)
stack.append(r0)
r2 = r1 << 6 + 0x53a35337
r3 = r1 * 5 + 0x9840294d
r2 = r2 ^ r3
r2 ^= r1 - 0x5eae4751
stack.pop(r0)
r0 += r2
stack.append(r0)

r0 = input[4]
r1 = input[5]
stack.append(r1)
r2 = r0 << 3 + 0x51e7647e
r3 = r0 * 3 + 0xe0b4140a
r2 = r2 ^ r3
r2 ^= r0 + 0xe6978f27
stack.pop(r1)
r1 += r2
stack.append(r1)
stack.append(r0)
r2 = r1 << 6 + 0x53a35337
r3 = r1 * 5 + 0x9840294d
r2 = r2 ^ r3
r2 ^= r1 - 0x5eae4751
stack.pop(r0)
r0 += r2
stack.append(r0)
```

ç„¶åå°±å¯ä»¥å†™è„šæœ¬å¾—åˆ°flagäº†ã€‚ğŸ‘ˆå®˜æ–¹çš„wp  (ã„’oã„’)

```python
v4 = [0]*7
v4[1] = 0xB0800699CB89CC89
v4[2] = 0x4764FD523FA00B19
v4[3] = 0x396A7E6DF099D700
v4[4] = 0xB115D56BCDEAF50A
v4[5] = 0x2521513C985791F4
v4[6] = 0xB03C06AF93AD0BE
for i in range(1, 7, 2):
enc_result = v4[i]
half_1 = v4[i+1] - (((enc_result << 6) + 0x53A35337) ^ (enc_result * 5 +
0x9840294D) ^ (enc_result - 0x5EAE4751))
half_1 &= 0xffffffffffffffff
print(half_1.to_bytes(8, 'little').decode(), end='')
half_2 = enc_result - ((((half_1 << 3) + 0x51E7647E) ^ ((half_1 * 3) +
0x0E0B4140A)) ^ (half_1 + 0xE6978F27))
half_2 &= 0xffffffffffffffff
print(half_2.to_bytes(8, 'little').decode(), end='')
print()
# d3ctf{cef9b994-2547-4844-ac0d-a097b75806a0}
```

# d3Hell

## åˆ†ædll

å…¶å®ï¼Œç¨‹åºä¸dllçš„å…·ä½“å…³ç³»æˆ‘è¿˜æ²¡ææ‡‚ï¼Œç¨‹åºåœ¨å“ªé‡Œè°ƒç”¨çš„dllæˆ‘è¿˜ä¸æ¸…æ¥šï¼Œå› æ­¤è·Ÿç€wpæç¤ºèµ°ã€‚

é¦–å…ˆï¼Œçœ‹DllMainï¼š

![DllMain](d3ctf2023/image-20230509193221462.png)

æ— è®ºç¨‹åºå¦‚ä½•è°ƒç”¨ï¼Œ64FC1628å‡½æ•°ä¸€å®šè¢«è°ƒç”¨äº†ï¼Œå› æ­¤æŸ¥çœ‹64FC1628ï¼š

![64FC1628å‡½æ•°](d3ctf2023/image-20230509193351163.png)

ç»wpæç¤ºï¼Œè¿™é‡Œä½¿ç”¨äº†å¤©å ‚ä¹‹é—¨ï¼ˆå¯ä»¥ä»`call $+5;`,`mov [ ], 23`,`retf`è§‚å¯Ÿå‡ºï¼‰ï¼Œå³ï¼š

- `call $+5`ï¼šè·³åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ŒcallæŒ‡ä»¤å¤§å°ä¸º5ï¼ŒåŒæ—¶å°†0x666C1642åœ°å€å…¥æ ˆï¼›

- `mov [rsp+0xA8-0xA4], 23h`ï¼šå°†æ ˆé¡¶16ä½æ•°æ®çš„å‰å…«ä½å˜æˆ0x23
- `add [rsp+0xA8-0xA8], 0Dh`ï¼šå°†æ ˆé¡¶16ä½æ•°æ® += 0x0Dï¼Œä½¿å…¶retfè¿”å›åœ°å€æŒ‡å‘0x666C164E
- `retf`ï¼šè¿œè¿”å›ï¼Œè¯¥æŒ‡ä»¤ä¼šä»æ ˆé¡¶å–å‡ºä¸€ä¸ªè¿”å›åœ°å€ï¼Œå†å–å‡ºä¸€ä¸ªcsæ®µé€‰æ‹©å­ï¼Œè¿™é‡Œçš„CSæ®µå˜æˆäº†0x23ï¼Œè¿”å›åœ°å€ä¸º0x666C164Eï¼Œç„¶åå¼€å§‹ä»¥32ä½æ¨¡å¼å¼€å§‹0x666C164Eå¤„çš„æŒ‡ä»¤

å…·ä½“äº†è§£å¤©å ‚ä¹‹é—¨ï¼Œçœ‹è¿™ä½âœŒ [å¤©å ‚ä¹‹é—¨ (Heaven's Gate) Cè¯­è¨€å®ç°

è¿™æ®µ32ä½çš„æŒ‡ä»¤å…·ä½“å¤šé•¿ç›®å‰è¿˜ä¸ç¡®å®šï¼Œæ‰€ä»¥å…ˆéƒ½dumpä¸‹æ¥ï¼Œè®©capstoneç¿»è¯‘æˆ32ä½æŒ‡ä»¤ã€‚

![32ä½æŒ‡ä»¤](d3ctf2023/image-20230509195823808.png)

å¾ˆæ˜æ˜¾ï¼Œå‰ä¸€éƒ¨åˆ†çš„ä»£ç æ˜¯åœ¨å¼‚æˆ–`0x666c169a - 0x666c18ea`è¿™éƒ¨åˆ†ï¼Œ

å› æ­¤ï¼Œæ‰‹åŠ¨å¼‚æˆ–åå†ç¿»è¯‘ï¼š

![å¼‚æˆ–åçš„32ä½æŒ‡ä»¤](d3ctf2023/image-20230509201456498.png)

`0x666c169a - 0x666c16a5`çš„ä»£ç æ˜¯å›åˆ°64ä½æ¨¡å¼ï¼Œå› æ­¤å°†ä¹‹åçš„éƒ¨åˆ†ç”¨64ä½è§£é‡Šã€‚

![ç»“æœæŒ‡ä»¤](d3ctf2023/image-20230509201924211.png)

ä¸ºäº†æ–¹ä¾¿åˆ†æï¼Œå°†ä»¥ä¸Šçš„å¤„ç†åœ¨idaå†™è„šæœ¬å¤„ç†ï¼Œç„¶ånopæ‰å¼‚æˆ–æ•°æ®ä»¥åŠæ¨¡å¼è½¬æ¢éƒ¨åˆ†çš„ä»£ç ã€‚

![61FC1628å‡½æ•°é€»è¾‘](d3ctf2023/image-20230509202310847.png)

å½»åº•å¾—åˆ°å‡½æ•°é€»è¾‘äº†ï¼Œä½†`61FC1602()`è¿™ä¸ªå‡½æ•°åˆ†æèµ·æ¥å¥½éº»çƒ¦ï¼ˆæ„Ÿè§‰æ˜¯ä¸€ä¸ªå°†æ•°è½¬åŒ–ä¸ºåè¿›åˆ¶å­—ç¬¦ä¸²çš„è¿‡ç¨‹ï¼‰ï¼Œæ‰€ä»¥åŠ¨æ€è·å–flagç»“æœï¼š698740305822331500978964939673142241ã€‚

![flagç»“æœ](d3ctf2023/image-20230509202501985.png)

æ³¨æ„ï¼š

1. è¿™ä¸ªflagç»“æœå°†æ”¾åœ¨exeçš„`0x405020`ã€‚

2. `61FC1628()`æœ‰æ£€æŸ¥4,202,264 = 0x401f18 åœ°å€éƒ¨åˆ†çš„æ•°æ®ï¼Œå› æ­¤å¦‚æœè¦ä¿®æ”¹Sleepä»£ç ï¼Œåˆ™éœ€è¦ä¿®æ”¹ä¸‹dllã€‚

   ![0x401f18åœ°å€éƒ¨åˆ†ä»£ç ](d3ctf2023/image-20230509203924821.png)

## åˆ†æexe

è¿™ä¸ªç¨‹åºå…‰æ˜¯çœ‹ç€å°±å¤´å¤§ï¼Œæ‰€ä»¥å°±ä»dllè·å–çš„flagè°ƒå°ï¼Œå»çœ‹çœ‹æ¯ä¸ªå‡½æ•°çš„å¤§æ¦‚ä½œç”¨ã€‚

è¿™é‡Œå°†flagè°ƒä¸º 0x1ED = 17 * 29ï¼Œç„¶åä¸€ä¸ªä¸ªå‡½æ•°å¤§æ¦‚çœ‹çœ‹ç»“æœå•¥çš„ã€‚

å› æ­¤ï¼Œå¤§æ¦‚é€»è¾‘å°±æ˜¯å°†flagåˆ†è§£ä¸ºä¸¤ä¸ªçº¦æ•°ï¼Œç„¶åéƒ½è¾“å‡ºåè¿›åˆ¶æ•°å‡ºæ¥ã€‚ğŸ‘ˆè¿™äº›æ˜¯wpä¸­è¯´çš„ï¼Œæˆ‘è¿˜æ²¡åˆ†æå‡ºæ¥å‘¢

ï¼ˆå…·ä½“åˆ†æçœ‹çœ‹æœ‰æ²¡æ—¶é—´å§  (ã„’oã„’ï¼‰ï¼‰

æ ¹æ®wpï¼Œå¯ä»¥è·³è¿‡æœ€è€—è´¹æ—¶é—´çš„`401E64`ï¼ˆåº”è¯¥æ˜¯æ±‚çº¦æ•°çš„å‡½æ•°ï¼‰ç„¶åå°†xmm0å¯„å­˜å™¨æ”¹ä¸ºflagçš„ä¸¤ä¸ªçº¦æ•°ä¹‹ä¸€ã€‚

![æ›´æ”¹xmm0å¯„å­˜å™¨](d3ctf2023/image-20230510102958001.png)

å¾—åˆ°flagï¼š

![flag](d3ctf2023/image-20230510103101324.png)
