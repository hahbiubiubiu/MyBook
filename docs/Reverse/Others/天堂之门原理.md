# å‰è¨€

æœ¬ç¯‡æ–‡ç« ä»…ä¸ºçœ‹wpå­¦ä¹ åˆ°çš„å¤©å ‚ä¹‹é—¨æŠ€æœ¯åšä¸ªæ€»ç»“ã€‚

å…·ä½“å­¦ä¹ ï¼Œçœ‹çœ‹è¿™äº›âœŒï¼š

ðŸ‘‰[å¤©å ‚ä¹‹é—¨ (Heaven's Gate) Cè¯­è¨€å®žçŽ° | 34r7hm4n's blog (bluesadi.cn)](http://blog.bluesadi.cn:4000/2021/11/06/å¤©å ‚ä¹‹é—¨-Heaven-s-Gate-Cè¯­è¨€å®žçŽ°/) ðŸ‘ˆè®²å¾—å¾ˆç»†ï¼Œçœ‹å®Œå°±æ‡‚

ðŸ‘‰[å¤©å ‚ä¹‹é—¨ (Heaven's Gate) - s0rry's Blog](http://s0rry.cn/archives/tian-tang-zhi-men-heavensgate#toc-head-2)

# WoW64

WOW64ï¼ˆWindows-On-Windows 64bitï¼‰æ˜¯X64 Windowsæ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªå­ç³»ç»Ÿï¼Œä¸º32ä½åº”ç”¨ç¨‹åºæä¾›è¿è¡ŒçŽ¯å¢ƒã€‚ç±»ä¼¼çš„è¿˜æœ‰WOW32å­ç³»ç»Ÿï¼Œè´Ÿè´£åœ¨32ä½Windowsç³»ç»Ÿä¸Šè¿è¡Œ16ä½åº”ç”¨ç¨‹åºã€‚

åœ¨64ä½ç³»ç»Ÿä¸­ï¼Œ32ä½çš„åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ä¸€ä¸ªWoW64çš„å­ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªå­ç³»ç»Ÿä¸º32ä½ç¨‹åºæä¾›äº†ä¸€ä¸ªç±»ä¼¼æ²™ç®±çš„è¿è¡ŒçŽ¯å¢ƒã€‚äº‹å®žä¸Šè¿™ä¸ª32ä½ç¨‹åºè¿è¡Œçš„çŽ¯å¢ƒä¹Ÿæ˜¯ä¸€ä¸ª64ä½çš„è¿è¡ŒçŽ¯å¢ƒï¼Œç³»ç»Ÿåœ¨åˆ›å»º32ä½è¿›ç¨‹æ—¶ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ª64ä½çš„è¿›ç¨‹ï¼Œç„¶åŽå†åœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ª32ä½çš„å­çŽ¯å¢ƒã€‚32ä½ç¨‹åºæ‰€è°ƒç”¨çš„ç³»ç»Ÿå‡½æ•°ï¼Œæœ€ç»ˆéƒ½è¦é€šè¿‡64ä½çš„åŠ¨æ€é“¾æŽ¥åº“è€Œå®žçŽ°ã€‚

Winodwsç³»ç»Ÿä¸­ï¼ŒCSæ®µå¯„å­˜å™¨ç”¨æ¥æ ‡è¯†ç›®å‰æ‰€è¿è¡Œçš„ä»£ç æ˜¯32ä½çš„ï¼Œè¿˜æ˜¯64ä½çš„ã€‚

ä»¥ä¸€ä¸ªä½¿ç”¨å¤©å ‚ä¹‹é—¨çš„ç¨‹åºä¸ºä¾‹ï¼Œå…¶ä¸º64ä½ç¨‹åºã€‚

ä¸€å¼€å§‹ä¸º64ä½æ¨¡å¼ï¼š

![64ä½ç¨‹åºçš„CSå¯„å­˜å™¨](å¤©å ‚ä¹‹é—¨åŽŸç†/image-20230510114220317.png)

åˆ‡æ¢åˆ°32ä½æ¨¡å¼åŽï¼š

![åˆ‡æ¢åˆ°32ä½æ¨¡å¼](å¤©å ‚ä¹‹é—¨åŽŸç†/image-20230510114530659.png)

# å¤©å ‚ä¹‹é—¨å®žçŽ°

## 32ä½å’Œ64ä½ä¹‹é—´çš„è½¬åŒ–

32ä½ â†’ 64ä½ï¼š

+ å°†`0x33`å…¥æ ˆ
+ å°†64ä½æŒ‡ä»¤åœ°å€å…¥æ ˆ
+ `retf` è¿œè¿”å›žï¼šå…ˆå–è¿”å›žåœ°å€ï¼Œå†å–`0x33`ä½œä¸ºCSå¯„å­˜å™¨ï¼Œå› æ­¤è·³è½¬çš„åœ°å€ä¸º`0x33:64ä½æŒ‡ä»¤åœ°å€`

```
push 0x33
push _next_x64_code
retf
```

64ä½ â†’ 32ä½ï¼š

+ å°†`0x23`å…¥æ ˆ
+ å°†32ä½æŒ‡ä»¤åœ°å€å…¥æ ˆ
+ `retfq` è¿œè¿”å›žï¼šå…ˆå–è¿”å›žåœ°å€ï¼Œå†å–`0x23`ä½œä¸ºCSå¯„å­˜å™¨ï¼Œå› æ­¤è·³è½¬çš„åœ°å€ä¸º`0x23:32ä½æŒ‡ä»¤åœ°å€`
  + `retq`ç›¸å½“äºŽ`pop ip; pop cs`
  + `retfq`æ˜¯æŒ‰64ä½è¿›è¡Œ`pop`ï¼Œ`retf`æ˜¯æŒ‰32ä½è¿›è¡Œ`pop`

```
push 0x23
push _nexr_x86_code
retfq
```

å…¶å®žå®žçŽ°çš„æ–¹å¼åº”è¯¥å¹¶ä¸æ˜¯é‚£ä¹ˆå›ºå®šï¼Œè™½ç„¶å¤§å·®ä¸å·®ï¼Œæ¯”å¦‚ä¸¾ä¾‹çš„ç¨‹åºä¸º64ä½ â†’ 32ä½ï¼Œå…¶æµç¨‹ä¸ºï¼š

![64FC1628å‡½æ•°](å¤©å ‚ä¹‹é—¨åŽŸç†/image-20230509193351163.png)

- `call $+5`ï¼šè·³åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ŒcallæŒ‡ä»¤å¤§å°ä¸º5ï¼ŒåŒæ—¶å°†`0x666C1642`åœ°å€å…¥æ ˆï¼›
  - ![call $+5](å¤©å ‚ä¹‹é—¨åŽŸç†/image-20230510121041395.png)
- `mov [rsp+0xA8-0xA4], 23h`ï¼šå°†æ ˆé¡¶32ä½æ•°æ®çš„å‰å…«ä½å˜æˆ0x23
  - ![æ›´æ”¹è¿”å›žåœ°å€çš„cs](å¤©å ‚ä¹‹é—¨åŽŸç†/image-20230510121350591.png)
- `add [rsp+0xA8-0xA8], 0Dh`ï¼šå°†æ ˆé¡¶64ä½æ•°æ® += 0x0Dï¼Œä½¿å…¶retfè¿”å›žåœ°å€æŒ‡å‘`0x23:0x666C164E`
  - ![æ›´æ”¹è¿”å›žåœ°å€](å¤©å ‚ä¹‹é—¨åŽŸç†/image-20230510121638859.png)
- `retf`ï¼šè¿œè¿”å›žï¼Œè¯¥æŒ‡ä»¤ä¼šä»Žæ ˆé¡¶å–å‡ºä¸€ä¸ªè¿”å›žåœ°å€ï¼Œå†å–å‡ºä¸€ä¸ªcsæ®µé€‰æ‹©å­ï¼Œè¿™é‡Œçš„CSæ®µå˜æˆäº†0x23ï¼Œè¿”å›žåœ°å€ä¸º`0x23:0x666C164E`ï¼Œç„¶åŽå¼€å§‹ä»¥32ä½æ¨¡å¼å¼€å§‹`0x666C164E`å¤„çš„æŒ‡ä»¤
  - ![CSæ›´æ”¹äº†](å¤©å ‚ä¹‹é—¨åŽŸç†/image-20230510121804080.png)

å®ƒ32ä½ â†’ 64ä½å°±æ›´å·®ä¸å¤šäº†ï¼š

å°†`push è¿”å›žåœ°å€`æ‹†æˆ`call + add`ã€‚

![32 â†’ 64](å¤©å ‚ä¹‹é—¨åŽŸç†/image-20230510122409063.png)

## ä»£ç å®žçŽ°

å®žçŽ°æ­¥éª¤ï¼š

1. å®žçŽ°æ¨¡å¼çš„åˆ‡æ¢
2. ä»£ç ï¼ˆå¯ä»¥æ˜¯ä»…æŒ‡ä»¤ä»£ç ï¼Œä¹Ÿå¯ä»¥æ˜¯è°ƒç”¨ç›¸å¯¹åº”ä½æ•°çš„å‡½æ•°ï¼Œä½†è¿™ä¼šéº»çƒ¦ä¸€äº›ï¼‰
3. åˆ‡æ¢å›žåŽŸæ¥çš„æ¨¡å¼

å­—èŠ‚ç ä¸Žæ±‡ç¼–çš„è½¬æ¢å¯ä»¥é€šè¿‡`keystone`å’Œ`capstone`èŽ·å–ã€‚

è¿™ä¸€éƒ¨åˆ†å°±æ²¡æœ‰å®žè·µäº†ï¼Œçœ‹çœ‹å„ä½âœŒçš„ä»£ç ï¼š

ä»¥ä¸‹æ˜¯[32ä½ä¸‹å¯è¿è¡Œçš„64ä½memcpyå‡½æ•°](http://blog.bluesadi.cn:4000/2021/11/06/å¤©å ‚ä¹‹é—¨-Heaven-s-Gate-Cè¯­è¨€å®žçŽ°/)ï¼š

> ```c
> void memcpy64(uint64_t dst, uint64_t src, uint64_t sz) {
> 	static uint8_t code[] = {
> 		/*	[bits 32]
> 			push 0x33
> 			push _next_x64_code
> 			retf
> 		*/
> 		0x6A, 0x33, 0x68, 0x78, 0x56, 0x34, 0x12, 0xCB,
> 		/*	[bits 64]
> 			push rsi
> 			push rdi
> 			mov rsi, src
> 			mov rdi, dst
> 			mov rcx, sz
> 			rep movsb
> 			pop rsi
> 			pop rdi
> 		*/
> 		0x56, 0x57,
> 		0x48, 0xBE, 0x88, 0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11,
> 		0x48, 0xBF, 0x88, 0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11,
> 		0x48, 0xB9, 0x88, 0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11,
> 		0xF3, 0xA4,
> 		0x5E, 0x5F,
> 		/*	[bits 64]
> 			push 0x23
> 			push _next_x86_code
> 			retfq
> 		*/
> 		0x6A, 0x23, 0x68, 0x78, 0x56, 0x34, 0x12, 0x48, 0xCB,
> 		/*	[bits 32]
> 			ret
> 		*/
> 		0xC3
> 	};
> 
> 	static uint32_t ptr = NULL;
> 	if (!ptr) {
> 		ptr = (uint32_t)VirtualAlloc(NULL, sizeof(code), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
> 		for (int i = 0; i < sizeof(code); i++) ((PBYTE)ptr)[i] = code[i];
> 	}
> 	*(uint32_t*)(ptr + 3) = ptr + 8;
> 	*(uint64_t*)(ptr + 12) = src;
> 	*(uint64_t*)(ptr + 22) = dst;
> 	*(uint64_t*)(ptr + 32) = sz;
> 	*(uint32_t*)(ptr + 47) = ptr + 53;
> 	((void(*)())ptr)();
> }
> ```
