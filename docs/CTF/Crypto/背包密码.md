## ç®—æ³•è§£é‡Š

å¯†ç é—®é¢˜æ˜¯ä¾é éš¾è§£çš„é—®é¢˜æ¥ç¡®ä¿å…¶åŠ å¯†æ€§ï¼ŒèƒŒåŒ…é—®é¢˜å°±æ˜¯èƒŒåŒ…å¯†ç çš„å›°éš¾é—®é¢˜ã€‚

> å‡è®¾ä¸€ä¸ªèƒŒåŒ…çš„æœ€å¤šå¯ä»¥æ‰¿é‡ä¸º`W`ï¼Œæœ‰`n`ä¸ªç‰©ä½“ï¼Œé‡é‡åˆ†åˆ«ä¸º`a1,a2,a3â€¦â€¦,an`ï¼Œå¹¶ä¸”æ¯ä¸ªç‰©å“åªèƒ½è¢«è£…ä¸€æ¬¡ï¼Œé—®è£…å“ªäº›ç‰©å“å¯ä»¥æ°å¥½ä½¿å¾—èƒŒåŒ…è£…æ»¡ã€‚

å¼å­è¡¨è¾¾ï¼š$b_1a_1 + b_2a_2 + ... + b_na_n = W$

`a`ä¸ºç‰©ä½“é‡é‡ï¼Œ`b`è¡¨ç¤ºæœ‰æˆ–æ²¡æœ‰ï¼Œå³0æˆ–1ï¼Œ0è¡¨ç¤ºæ²¡æœ‰ï¼Œ1è¡¨ç¤ºæœ‰ã€‚

### è¶…é€’å¢åºåˆ—

å®šä¹‰ï¼š**åºåˆ—ä¸­æ¯ä¸€é¡¹éƒ½å¤§äºå‰é¢æ‰€æœ‰é¡¹ä¹‹å’Œ**ï¼Œä¾‹å¦‚ï¼š`[1,3,6,11,23,45]`

åœ¨èƒŒåŒ…é—®é¢˜å½“ä¸­ï¼Œè‹¥ç‰©å“çš„é‡é‡åˆ—è¡¨æ˜¯ä¸€ä¸ªè¶…é€’å¢åºåˆ—ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å¾ˆå®¹æ˜“çš„å‡ºç­”æ¡ˆçš„ï¼Œè§£å†³è¶…é€’å¢åºåˆ—çš„èƒŒåŒ…é—®é¢˜ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. å‡å¦‚æœ‰ä¸€ä¸ªèƒŒåŒ…ï¼ŒèƒŒåŒ…çš„é‡é‡å·²çŸ¥ï¼Œå°†è¿™ä¸ªèƒŒåŒ…çš„é‡é‡ä¸æˆ‘ä»¬å·²çŸ¥çš„è¶…é€’å¢åºåˆ—ä¸­çš„æœ€å¤§å€¼è¿›è¡Œæ¯”è¾ƒ
   1. å¦‚æœèƒŒåŒ…çš„é‡é‡å°äºè¿™ä¸ªæ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°ä¸åœ¨èƒŒåŒ…ä¸­
   2. å¦‚æœé‡é‡å¤§äºæˆ–ç­‰äºè¿™ä¸ªæ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°åœ¨èƒŒåŒ…ä¸­
   3. ç”¨èƒŒåŒ…çš„é‡é‡å‡å»è¿™ä¸ªæ•°ï¼Œå¾—å‡ºçš„ç»“æœç»§ç»­ä¸åºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªæ•°è¿›è¡Œæ¯”è¾ƒï¼Œé‡å¤æ¯”è¾ƒç›´åˆ°æ¯”è¾ƒå®Œä¸ºæ­¢
   4. å¦‚æœèƒŒåŒ…çš„æ€»é‡é‡å‡åˆ°0åˆ™è¯¥èƒŒåŒ…é—®é¢˜å¾—å‡ºè§£ï¼Œåä¹‹åˆ™æ— è§£

### åŠ è§£å¯†

1. ç§é’¥ï¼š$[a_1, a_2, a_3,...,a_n]$
   1. è¶…é€’å¢åºåˆ—
2. å…¬é’¥ï¼š$d \equiv n*a \bmod m $
   1. é€‰å–$n,m$ï¼Œç§é’¥é‡Œé¢çš„æ¯ä¸€ä¸ªå€¼ä¹˜ä»¥$n$æ¨¡$m$
   2. $m$åº”å¤§äºåºåˆ—ä¸­æ‰€æœ‰æ•°ä¹‹å’Œ
   3. $n$ä¸$m$äº’ç´ 
3. åŠ å¯†
   1. å¯¹äºŒè¿›åˆ¶æ˜æ–‡æ•°æ®åˆ†ç»„ï¼Œæ¯ç»„é•¿åº¦ä¸º$len(d)$
   2. å°†å…¬é’¥ä¸äºŒè¿›åˆ¶æ•°æ®ä¸€ä¸€å¯¹åº”ï¼Œæ±‚å’Œ
   3. ![img](èƒŒåŒ…å¯†ç /3d7e75280172644242fef05e3c5f9912.png)
4. è§£å¯†
   1. è®¡ç®—$n$å…³äº$m$çš„é€†å…ƒï¼š$n^{-1} *n\equiv 1 \bmod m$
   2. æ¯ä¸ªå¯†æ–‡ä¹˜$n^{-1}$åœ¨æ¨¡$m$ï¼š
      1. $m' \equiv c * n^{-1} \bmod m$
      2. $m' \equiv d*m*n^{-1} \equiv n * a * m * n * n^{-1} \equiv a*n \bmod m$
   3. ç”¨ç§é’¥è¿›è¡Œæ±‚è§£$m$ï¼ˆè¶…é€’å¢åºåˆ—è§£æ³•ï¼‰
   4. ![](èƒŒåŒ…å¯†ç /image-20240417133219492.png)

#### ä»£ç 

```Python
import gmpy2
import math

# è§£å†³èƒŒåŒ…é—®é¢˜
def resolve(a, w):
    b = []
    for i in range(len(a) - 1, -1 , -1):
        an = a[i]
        if w < an:
            b.insert(0, 0)
        else:
            w = w - an
            b.insert(0, 1)
    return b

# ä»¥ç§é’¥ç”Ÿæˆå…¬é’¥
def create_pubkey(private_key, n, m):
    assert m > sum(private_key), gmpy2.gcd(n, m) == 1
    pubkey = [(k * n) % m for k in private_key]
    return pubkey

# ç”¨ç”Ÿæˆçš„å…¬é’¥åŠ å¯†
def encrypto(message, pubkey):
    message = [int(bit) for bit in bin(int.from_bytes(message.encode(), 'big'))[2:]]
    message = [0] * (8 - len(message) % 8) + message
    message += [0] * (len(pubkey) - len(message) % len(pubkey))
    cipher = []
    for i in range(0, len(message), len(pubkey)):
        cipher.append(0)
        for j in range(len(pubkey)):
            cipher[-1] += message[i + j] * pubkey[j]
    return cipher

# å¤„ç†å¯†æ–‡ï¼Œå†ç”¨ç§é’¥è§£å¯†
def decrypto(cipher, n, m, private_key):
    phi_n = gmpy2.invert(n, m)
    message = []
    for c in cipher:
        cip = c * phi_n % m
        message += resolve(private_key, cip)
    message = message[:-(len(message) % 8)]
    message = int(''.join(str(i) for i in message), 2)
    message = message.to_bytes(
        math.ceil(message.bit_length() / 8), 'big'
    ).decode()
    return message

# ç¤ºä¾‹
if __name__ == '__main__':
    # ç§é’¥ä¸ºè¶…é€’å¢åºåˆ—
    private_key = [1, 3, 6, 11, 23, 45]
    n = 41
    m = 95
    message = "helloworld"
    pubkey = create_pubkey(private_key, n, m)
    print(f'pubkey: {pubkey}')
    cipher = encrypto(message, pubkey)
    print(f'cipher: {cipher}')
    mes = decrypto(cipher, n, m, private_key)
    print(f'message: {mes}')
```

### ç ´è§£

æœ‰è¯¦ç»†è®² ğŸ‘‰

[asis-ctf-quals-2014 ](https://github.com/ctfs/write-ups-2014/tree/b02bcbb2737907dd0aa39c5d4df1d1e270958f54/asis-ctf-quals-2014/archaic)

[æ ¼å¯†ç ç¬”è®°ï¼ˆäºŒï¼‰](https://www.ruanx.net/lattice-2/)

#### challenge

```Python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from sage.all import *
from secret import flag
from Crypto.Util.number import *
from math import log2

class Knapsack:
    def __init__(self,n,m):
        self.M = []
        self.n = n
        self.m = self.pre(m)
        self.A = 0
        self.B = 0
        
    def pre(self,m):
        tmp_m = bin(m)[2:]
        t = []
        for tmp in tmp_m:
            t.append(int(tmp))
        return t
    
    def get_M(self):
        seq = [randint(2**34,2**35) for _ in range(self.n)]
        self.M = seq
        
    def calc_density(self):
        t = log2(max(self.M))
        d = self.n/t
        print(d)

    def enc(self):
        self.get_M()
        self.calc_density()
        C = 0
        for t in range(len(self.m)):
            C += self.m[t] * self.M[t]
        print(f"C = {C}")
        print(f"M = {self.M}")
        
if __name__=="__main__":
    m = bytes_to_long(flag.encode())
    n = m.bit_length()
    k = Knapsack(n,m)
    k.enc()

# C = 231282844744
# M = [27811518167, 19889199464, 19122558731, 19966624823, 25670001067, 30690729665, 23936341812, 31011714749, 30524482330, 21737374993, 17530717152, 19140841231, 33846825616, 17334386491, 28867755886, 29354544582, 21758322019, 27261411361, 31465376167, 26145493792, 27075307455, 33514052206, 25397635665, 21970496142, 30801229475, 22405695620, 18486900933, 27071880304, 17919853256, 18072328152, 21108080920]
```

##### exp

```python
from Crypto.Util.number import *
import math
C = 231282844744
M = [
    27811518167, 19889199464, 19122558731, 19966624823, 
    25670001067, 30690729665, 23936341812, 31011714749, 
    30524482330, 21737374993, 17530717152, 19140841231, 
    33846825616, 17334386491, 28867755886, 29354544582, 
    21758322019, 27261411361, 31465376167, 26145493792, 
    27075307455, 33514052206, 25397635665, 21970496142, 
    30801229475, 22405695620, 18486900933, 27071880304, 
    17919853256, 18072328152, 21108080920
]
nbit = len(M)
A = Matrix(ZZ, nbit+1, nbit+1)
for i in range(nbit):
    A[i,i] = 1
    A[i,nbit] = M[i]
A[nbit,nbit] = -int(C)

res = A.LLL()
for i in range(0, nbit + 1):
    # print solution
    M = res.row(i).list()
    flag = True
    for m in M:
        if m != 0 and m != 1:
            flag = False
            break
    if flag:
        print(i, M)
        M = ''.join(str(j) for j in M)
        # remove the last bit
        M = M[:-1]
        M = int(M, 2)
        M = M.to_bytes(math.ceil(M.bit_length() / 8), 'big').decode()
        print(M)
```

SageMath shell è¿è¡Œï¼š

![](èƒŒåŒ…å¯†ç /image-20240417160241570.png)

